name: relaywatch-ci

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      targets:
        description: 逗号分隔的 target 列表，例如 x86/64 或 x86_64
        required: false
        default: ''
      openwrt_versions:
        description: 逗号分隔的 OpenWrt 版本列表，例如 23.05.2
        required: false
        default: ''
  repository_dispatch:

permissions:
  contents: write

jobs:
  determine-matrix:
    name: 准备构建矩阵
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.compute.outputs.matrix }}
    steps:
      - name: 生成矩阵配置
        id: compute
        shell: bash
        run: |
          set -euo pipefail
          matrix_json=$(python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          DEFAULT_TARGETS = ["x86/64"]
          DEFAULT_VERSIONS = ["23.05.2", "22.03.5"]

          event_path = Path(os.environ.get("GITHUB_EVENT_PATH", ""))
          payload = {}
          if event_path.is_file():
              try:
                  payload = json.loads(event_path.read_text(encoding="utf-8"))
              except json.JSONDecodeError:
                  payload = {}

          client_payload = payload.get("client_payload") or {}
          inputs = payload.get("inputs") or {}

          def normalize(value):
              if value in (None, ""):
                  return []
              if isinstance(value, list):
                  items = value
              else:
                  items = [value]
              result = []
              for item in items:
                  if item in (None, ""):
                      continue
                  if isinstance(item, str):
                      parts = [part.strip() for part in item.split(",")]
                      result.extend([part for part in parts if part])
                  else:
                      result.append(str(item))
              return result

          def dedupe(items):
              seen = set()
              ordered = []
              for item in items:
                  if item not in seen:
                      seen.add(item)
                      ordered.append(item)
              return ordered

          def format_target(value):
              value = value.strip()
              if "/" in value:
                  return value
              if "_" in value:
                  head, tail = value.split("_", 1)
                  return f"{head}/{tail}"
              return value

          targets = []
          targets.extend(normalize(client_payload.get("target")))
          targets.extend(normalize(client_payload.get("targets")))
          targets.extend(normalize(inputs.get("target")))
          targets.extend(normalize(inputs.get("targets")))

          versions = []
          versions.extend(normalize(client_payload.get("openwrt_version")))
          versions.extend(normalize(client_payload.get("openwrt_versions")))
          versions.extend(normalize(inputs.get("openwrt_version")))
          versions.extend(normalize(inputs.get("openwrt_versions")))

          targets = [format_target(t) for t in dedupe(targets) if t]
          versions = dedupe([v for v in versions if v])

          if not targets:
              targets = DEFAULT_TARGETS
          if not versions:
              versions = DEFAULT_VERSIONS

          matrix = {"openwrt_version": versions, "target": targets}
          print(json.dumps(matrix))
          PY
          )
          echo "matrix=${matrix_json}" >> "$GITHUB_OUTPUT"

  build:
    needs: determine-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.determine-matrix.outputs.matrix) }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install host prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 rsync unzip \
            zlib1g-dev file wget xz-utils

      - name: Download OpenWrt SDK
        id: sdk
        shell: bash
        run: |
          set -euo pipefail
          ARCH='${{ matrix.target }}'
          VERSION='${{ matrix.openwrt_version }}'
          ARCH_DIR="${ARCH%/*}"
          SUBTARGET="${ARCH#*/}"
          BASE_URL="https://downloads.openwrt.org/releases/${VERSION}/targets/${ARCH_DIR}/${SUBTARGET}"
          export BASE_URL
          SDK_TARBALL=$(python3 - <<'PY'
          import os, sys, urllib.request
          base = os.environ["BASE_URL"]
          with urllib.request.urlopen(base + "/") as resp:
              html = resp.read().decode()
          for token in html.split('"'):
              if token.startswith("openwrt-sdk") and token.endswith(".tar.xz"):
                  print(token)
                  break
          else:
              sys.exit("No SDK tarball found")
          PY
          )
          if [ -z "$SDK_TARBALL" ]; then
            echo "SDK tarball not located under ${BASE_URL}" >&2
            exit 1
          fi
          wget --show-progress --progress=dot:giga --output-document=sdk.tar.xz -- "${BASE_URL}/${SDK_TARBALL}"
          SDK_DIR="openwrt-sdk"
          rm -rf "$SDK_DIR"
          mkdir -p "$SDK_DIR"
          if ! tar -xJf sdk.tar.xz --strip-components=1 -C "$SDK_DIR"; then
            echo "Failed to extract SDK tarball" >&2
            exit 1
          fi
          if [ ! -f "$SDK_DIR/feeds.conf.default" ]; then
            echo "Extracted SDK directory does not contain feeds.conf.default" >&2
            exit 1
          fi
          rm -f sdk.tar.xz
          echo "sdk-dir=${SDK_DIR}" >> "$GITHUB_OUTPUT"
          {
            echo "SDK_DIR=${SDK_DIR}"
            echo "ARCH_DIR=${ARCH_DIR}"
            echo "SUBTARGET=${SUBTARGET}"
            echo "BASE_URL=${BASE_URL}"
          } >> "$GITHUB_ENV"

      - name: Cache OpenWrt downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.SDK_DIR }}/dl
          key: openwrt-dl-${{ matrix.openwrt_version }}-${{ matrix.target }}

      - name: Inject relaywatch sources
        run: |
          set -euo pipefail
          mkdir -p "$SDK_DIR/package/network/services/relaywatch"
          rsync -a --delete package/network/services/relaywatch/ "$SDK_DIR/package/network/services/relaywatch/"
          pushd "$SDK_DIR" >/dev/null
          ./scripts/feeds update -a
          popd >/dev/null
          mkdir -p "$SDK_DIR/feeds/luci/applications"
          rsync -a --delete feeds/luci/applications/luci-app-relaywatch/ "$SDK_DIR/feeds/luci/applications/luci-app-relaywatch/"
          pushd "$SDK_DIR" >/dev/null
          ./scripts/feeds install -a
          ./scripts/feeds uninstall luci-app-relaywatch || true
          ./scripts/feeds install -p luci luci-app-relaywatch || ./scripts/feeds install luci-app-relaywatch || true
          mkdir -p package/feeds/luci
          ln -sfn "$PWD/feeds/luci/applications/luci-app-relaywatch" package/feeds/luci/luci-app-relaywatch
          {
            echo 'CONFIG_PACKAGE_relaywatch=y'
            echo 'CONFIG_PACKAGE_luci-app-relaywatch=y'
          } >> .config
          make defconfig
          popd >/dev/null

      - name: Build relaywatch packages
        run: |
          set -euo pipefail
          cd "$SDK_DIR"
          make package/relaywatch/compile V=s
          make package/feeds/luci/luci-app-relaywatch/compile V=s

      - name: 准备制品名称
        if: always()
        run: |
          SAFE_TARGET='${{ matrix.target }}'
          SAFE_TARGET="${SAFE_TARGET//\//-}"
          echo "ARTIFACT_NAME=relaywatch-${{ matrix.openwrt_version }}-${SAFE_TARGET}" >> "$GITHUB_ENV"

      - name: Archive IPK artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            ${{ env.SDK_DIR }}/bin/packages/**/relaywatch*.ipk
            ${{ env.SDK_DIR }}/bin/packages/**/luci-app-relaywatch*.ipk

  publish:
    name: 发布构建产物
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' }}
    steps:
      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          pattern: relaywatch-*
          merge-multiple: true
          path: artifacts

      - name: 列出构建产物
        run: |
          ls -R artifacts

      - name: 校验构建产物
        run: |
          set -euo pipefail
          shopt -s nullglob globstar
          files=(artifacts/**/*.ipk)
          if [ ${#files[@]} -eq 0 ]; then
            echo "未找到任何 IPK 文件" >&2
            exit 1
          fi
          printf '即将发布的文件:\n'
          printf '  %s\n' "${files[@]}"

      - name: 生成发布信息
        run: |
          set -euo pipefail
          TAG="build-${GITHUB_RUN_ID}"
          NAME="relaywatch 构建 #${GITHUB_RUN_NUMBER}"
          echo "RELEASE_TAG=${TAG}" >> "$GITHUB_ENV"
          echo "RELEASE_NAME=${NAME}" >> "$GITHUB_ENV"

      - name: 发布到 GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          draft: true
          prerelease: true
          files: artifacts/**/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
