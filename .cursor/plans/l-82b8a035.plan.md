<!-- 82b8a035-2460-401e-8e6a-314b360dfd72 aab5dda7-aee6-4ff1-9a0c-dbb7221d2e4d -->
# LuCI 无线中继看门狗（基于 relayd）

### 目标与范围

- 基于 OpenWrt 原生 relayd/无线 STA 客户端实现无线中继（同网段桥接）。
- 周期性连通性检测；失败后在预设候选网络间自动切换。
- 提供 LuCI 界面管理候选网络、检测策略、手动操作与日志。
- 具备冷却/黑名单/回滚，避免频繁切换与劣化。

### 架构设计

- 后端守护进程：`relaywatchd`（procd 管理）执行健康检测与切换编排。
- 配置存储：UCI 文件 `/etc/config/relaywatch`，包含全局策略与候选网络。
- 系统集成：通过 netifd/UCI 配置 `wireless` 中 STA 接口与 `relayd` 实例。
- 事件钩子：hotplug wireless 监听关联/断连，动态调整检测节奏与状态。
- 前端界面：`luci-app-relaywatch`，提供设置、候选管理、状态与日志。

### UCI 配置 Schema（关键）

- 文件：`/etc/config/relaywatch`
- 段与选项：
  - `config relaywatch 'global'`
    - `option enabled '1'` 是否启用
    - `option iface 'wwan'` STA 接口逻辑名（如 `wwan`）
    - `option lan_bridge 'br-lan'` LAN 桥名称（供 relayd 参考）
    - `option relayd_instance 'bridge'` relayd 段名
    - `option check_method 'ping|http'` 检测方式
    - `option check_target '1.1.1.1,8.8.8.8'` 目标 IP/URL
    - `option check_interval '30'` 周期（秒）
    - `option fail_threshold '3'` 连续失败阈值
    - `option switch_cooldown '120'` 切换冷却（秒）
    - `option blacklist_time '600'` 黑名单时间（秒）
    - `option dhcp_renew '1'` 切换后是否更新租约
  - `config candidate`
    - `option ssid 'CafeWiFi'`
    - `option encryption 'psk2'`
    - `option key 'xxxx'`
    - `option bssid 'xx:xx:xx:xx:xx:xx'`（可选，锁定 AP）
    - `option priority '10'`（数值越大优先级越高）
    - `option disabled '0'`

最小示例：

```12:25:/etc/config/relaywatch
config relaywatch 'global'
	option enabled '1'
	option iface 'wwan'
	option lan_bridge 'br-lan'
	option relayd_instance 'bridge'
	option check_method 'ping'
	option check_target '1.1.1.1,8.8.8.8'
	option check_interval '30'
	option fail_threshold '3'
	option switch_cooldown '120'

config candidate
	option ssid 'Home_AP'
	option encryption 'psk2'
	option key 'password'
	option priority '100'
```

### 运行逻辑

- 守护进程 `/usr/sbin/relaywatchd`（sh/Lua）由 `/etc/init.d/relaywatch` 启动：

1) 每 `check_interval` 执行一次健康检查（多目标 ping 或 HTTP GET，带超时）。

2) 连续失败达到 `fail_threshold` 触发切换流程。

3) 选择未被黑名单的最高优先级候选；可用 `ubus call iwinfo scan` 或 `iw` 扫描校验存在；应用到 STA 接口（UCI 写入），执行 `wifi reload` 与必要的 `relayd`/网络 up；需要时 `dhclient`/`udhcpc` 更新租约；进入冷却期。

4) 若在关联或宽限健康检查阶段失败，则将该候选拉黑 `blacklist_time`，继续尝试下一个。

5) 在 `/var/run/relaywatch/state.json` 维护当前/历史状态；写入 syslog 与 `/var/log/relaywatch.log`（滚动限制）。

6) 安全回滚：若连续两次切换失败，回到上次已知可用候选。

- procd 启动脚本示例：
```12:28:/etc/init.d/relaywatch
START=95
USE_PROCD=1
start_service() {
	procd_open_instance
	procd_set_param command /usr/sbin/relaywatchd -f
	procd_set_param respawn 300 5 5
	procd_close_instance
}
stop_service() { :; }
```

- 切换核心伪代码：
```12:24:/usr/sbin/relaywatchd
select_next_candidate()
apply_uci_wifi_sta(ssid,key,enc,bssid)
wifi reload
ifup relay   # relay/relayd 依赖时
wait_assoc_and_ip 20s
health_check_grace 20s
```


### LuCI 界面

- 包名：`luci-app-relaywatch`
- 目录：
  - 控制器：`/usr/lib/lua/luci/controller/relaywatch.lua`
  - CBI 模型：`/usr/lib/lua/luci/model/cbi/relaywatch/settings.lua`、`/usr/lib/lua/luci/model/cbi/relaywatch/candidates.lua`
  - 视图：`/usr/lib/lua/luci/view/relaywatch/status.htm`
  - 语言包：`po/zh_Hans/relaywatch.po`、`po/en/relaywatch.po`
- 功能：
  - 全局启停、检测参数、阈值与冷却设置。
  - 候选列表增删改查、优先级、BSSID 锁定、禁用启用。
  - 按钮：扫描并导入附近 AP、立即检测、切换到选中候选。
  - 状态页：当前 SSID/BSSID、RSSI、IP、relayd 状态、最近事件与日志尾部。

### 需要新增的文件

- 后端
  - `/usr/sbin/relaywatchd`（核心逻辑）
  - `/etc/init.d/relaywatch`（procd 服务）
  - `/etc/hotplug.d/wireless/99-relaywatch`（无线事件钩子）
  - `/etc/config/relaywatch`（默认配置）
- LuCI
  - `/usr/lib/lua/luci/controller/relaywatch.lua`
  - `/usr/lib/lua/luci/model/cbi/relaywatch/settings.lua`
  - `/usr/lib/lua/luci/model/cbi/relaywatch/candidates.lua`
  - `/usr/lib/lua/luci/view/relaywatch/status.htm`
  - `po/zh_Hans/relaywatch.po`
- 打包
  - `feeds/luci/applications/luci-app-relaywatch/Makefile`
  - `package/network/services/relaywatch/Makefile`

### 依赖

- 运行：`relayd`、`iwinfo`、`jsonfilter`、`libubus`、`uclient-fetch`（HTTP）
- LuCI：`luci-base`、`luci-compat`（CBI）、`luci-lib-ipkg`（可选，用于 UX）

### 兼容性

- 适配 OpenWrt 21.02/22.03/23.05/24.x；兼容 `wifi reload`/`wifi up` 差异、`ubus iwinfo` 可用性差异。

### 安全与回滚

- 记录最后可用候选；失败时快速回退。
- 切换间隔冷却，整轮失败后指数退避。

### 测试

- 守护进程函数级单测（shell/Lua）；
- 手工：断电 AP、关闭 DHCP、门户劫持等场景；
- LuCI：表单校验、状态数据、按钮动作；
- UCI 回滚：关联失败时恢复原值。

### 交付物

- `luci-app-relaywatch` 与 `relaywatch` 守护进程 IPK；
- 默认配置与中英语言包；
- README（安装、升级、已知问题）。

### To-dos

- [ ] Create package skeletons for daemon and LuCI app
- [ ] Define /etc/config/relaywatch schema and defaults
- [ ] Implement relaywatchd health-check and switching loop
- [ ] Add /etc/init.d/relaywatch with procd respawn
- [ ] Add /etc/hotplug.d/wireless hook for assoc/disassoc
- [ ] Implement LuCI controller and routes
- [ ] Implement CBI models for settings and candidates
- [ ] Build status view with scan/import and actions
- [ ] Write UCI apply logic for STA and relayd
- [ ] Implement logging and /var/run state with blacklist
- [ ] Add version guards for wifi/iwinfo/ubus behaviors
- [ ] Write Makefiles and i18n; produce IPKs
- [ ] Manual test matrix and minimal unit tests